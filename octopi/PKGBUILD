
pkgname=octopi
pkgver=0.9.0
pkgrel=2
_commit=251822c88747c216c6ebb9a342a80097ee744117
pkgdesc="This is Octopi, a powerful Pacman frontend using Qt libs"
url="https://octopiproject.wordpress.com/"
arch=('x86_64')
license=('GPL2')
depends=('pacman' 'pacman-contrib' 'pkgfile' 'knotifications' 'alpm_octopi_utils' 'qtermwidget')
groups=('system')
#install=octopi.install
source=("https://github.com/aarnt/octopi/archive/${_commit}.zip"
        "images3.tar.xz"
        "https://github.com/aarnt/octopi/commit/a9d9eb30d37e97369cfc64204fe0bde9e0e29918.diff"
        "https://github.com/aarnt/octopi/commit/c413caadd11883ffcebf13ce515fb17bc23ebd27.diff"
        'transactiondialog.diff')
md5sums=('d08993641aa9a7b2d8c4375d3413e14a'
         '3c3345539c8500d303f33f890fe733fe'
         '94aa6b71b4f42f5523be82dccc90f266'
         'acf41ab51671385d79832dca69938742'
         '5a05c26c1ab695348a446f119503afe7')

prepare() {
   cd ${pkgname}-${_commit}/
   rm -r resources/images
   mv -iv ${srcdir}/images/ resources/
   cp resources/images/octopi_green.png resources/images/octopi.png

   # enable the kstatus switch
   sed -e "s|#KSTATUS|KSTATUS|" -i notifier/octopi-notifier/octopi-notifier.pro
   
   sed -e "s|pacman -U --force|pacman -U|" -i src/pacmanexec.cpp
   #sed -e "s|return p.readAllStandardOutput();|return p.toLatin1();|" -i src/unixcommand.cpp
   
   patch -R -p1 -i ${srcdir}/a9d9eb30d37e97369cfc64204fe0bde9e0e29918.diff
   #patch -R -p1 -i ${srcdir}/c413caadd11883ffcebf13ce515fb17bc23ebd27.diff
   #patch -p1 -i ${srcdir}/transactiondialog.diff
}
         
build() {
   cd ${pkgname}-${_commit}
   
   /usr/lib/qt5/bin/qmake octopi.pro
   make
   
   cd notifier/pacmanhelper
   /usr/lib/qt5/bin/qmake pacmanhelper.pro
   make
   cd ../..
   
   cd notifier/octopi-notifier
   /usr/lib/qt5/bin/qmake octopi-notifier.pro
   make
   cd ../..
   
   cd cachecleaner
   /usr/lib/qt5/bin/qmake octopi-cachecleaner.pro
   make
}

package() {
   cd ${pkgname}-${_commit}
   make INSTALL_ROOT=${pkgdir} install
   
   cd notifier/pacmanhelper
   make INSTALL_ROOT=${pkgdir} install
   cd ../..
   
   cd notifier/octopi-notifier
   make INSTALL_ROOT=${pkgdir} install
   cd ../..
   
   cd cachecleaner
   make INSTALL_ROOT=${pkgdir} install
}
